"use strict";(self.webpackChunksupastash_docs=self.webpackChunksupastash_docs||[]).push([[606],{5438:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"replication-mode","title":"\ud83d\udd01 Replication Mode","description":"Supastash determines incremental synchronization using a replication cursor, a dedicated timestamp column used to decide which rows are new since the last successful sync.","source":"@site/docs/replication-mode.md","sourceDirName":".","slug":"/replication-mode","permalink":"/supastash/docs/replication-mode","draft":false,"unlisted":false,"editUrl":"https://github.com/0xZekeA/supastash/tree/main/docs-site/docs/replication-mode.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Configuration","permalink":"/supastash/docs/configuration"},"next":{"title":"Sync Flows","permalink":"/supastash/docs/sync-flows"}}');var i=s(4848),t=s(8453);const d={},l="\ud83d\udd01 Replication Mode",c={},a=[{value:"1\ufe0f\u20e3 Client-Side Replication (Legacy)",id:"1\ufe0f\u20e3-client-side-replication-legacy",level:3},{value:"\u26a0\ufe0f The Problem (Important)",id:"\ufe0f-the-problem-important",level:4},{value:"What Happens?",id:"what-happens",level:4},{value:"2\ufe0f\u20e3 Server-Side Replication (Recommended)",id:"2\ufe0f\u20e3-server-side-replication-recommended",level:3},{value:"What Happens?",id:"what-happens-1",level:3},{value:"\ud83d\udee1 Why Server-Side Is Better",id:"-why-server-side-is-better",level:2},{value:"\ud83c\udfd7 What You Must Add (Server-Side Mode)",id:"-what-you-must-add-server-side-mode",level:2},{value:"\ud83d\udd27 Trigger Function (Server-Controlled Arrival)",id:"-trigger-function-server-controlled-arrival",level:3},{value:"\ud83d\udd01 Apply to Multiple Tables",id:"-apply-to-multiple-tables",level:2},{value:"\ud83d\udccc Final Comparison",id:"-final-comparison",level:2},{value:"\ud83d\udd1a Summary",id:"-summary",level:2}];function o(e){const n={blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"-replication-mode",children:"\ud83d\udd01 Replication Mode"})}),"\n",(0,i.jsxs)(n.p,{children:["Supastash determines incremental synchronization using a ",(0,i.jsx)(n.strong,{children:"replication cursor"}),", a dedicated timestamp column used to decide which rows are new since the last successful sync."]}),"\n",(0,i.jsx)(n.p,{children:"Every sync cycle answers one core question:"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"Which rows have arrived after this device\u2019s last_sync_marker?"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The column used as that marker depends on your selected ",(0,i.jsx)(n.code,{children:"replicationMode"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Choosing the correct replication mode directly impacts data consistency across multiple devices and long offline sessions."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h1,{id:"-two-replication-modes",children:"\ud83e\udded Two Replication Modes"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'configureSupastash({\n  replicationMode: "client-side", // or "server-side"\n});\n'})}),"\n",(0,i.jsx)(n.h3,{id:"1\ufe0f\u20e3-client-side-replication-legacy",children:"1\ufe0f\u20e3 Client-Side Replication (Legacy)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Uses:"})," ",(0,i.jsx)(n.code,{children:"updated_at"})," as the sync cursor."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"How It Works"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Every device updates ",(0,i.jsx)(n.code,{children:"updated_at"})," locally."]}),"\n",(0,i.jsxs)(n.li,{children:["During sync, Supastash pulls rows where: ",(0,i.jsx)(n.code,{children:"updated_at > last_synced_at"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Pros:"})," Simple. No extra server setup required."]}),"\n",(0,i.jsx)(n.h4,{id:"\ufe0f-the-problem-important",children:"\u26a0\ufe0f The Problem (Important)"}),"\n",(0,i.jsxs)(n.p,{children:["Because ",(0,i.jsx)(n.code,{children:"updated_at"})," is generated on the device:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Devices may be offline for a long time."}),"\n",(0,i.jsx)(n.li,{children:"A device may reconnect later and push old updates."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Real Edge Case:"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"10:00 AM"})," \u2014 Device A updates a row while offline.",(0,i.jsx)(n.br,{}),"\n","\u2192 ",(0,i.jsx)(n.code,{children:"updated_at = 10:00"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"10:05 AM"})," \u2014 Device B updates the same table (offline).",(0,i.jsx)(n.br,{}),"\n","\u2192 ",(0,i.jsx)(n.code,{children:"updated_at = 10:05"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"10:10 AM"})," \u2014 Device B reconnects and pushes its update to the server."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"10:20 AM"})," \u2014 Device C syncs, pulls Device B\u2019s update, and stores:",(0,i.jsx)(n.br,{}),"\n","\u2192 ",(0,i.jsx)(n.code,{children:"last_synced_at = 10:05"})," for that table."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Later \u2014 Device A reconnects and pushes its update (",(0,i.jsx)(n.code,{children:"updated_at = 10:00"}),")."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"what-happens",children:"What Happens?"}),"\n",(0,i.jsxs)(n.p,{children:["Device C will ",(0,i.jsx)(n.strong,{children:"never receive Device A\u2019s update"}),", because:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"10:00 < last_synced_at (10:05)\n"})}),"\n",(0,i.jsx)(n.p,{children:"From Device C\u2019s perspective, the update appears older than its last sync checkpoint \u2014 so it is skipped."}),"\n",(0,i.jsx)(n.p,{children:"This is the core weakness of client-side replication."}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u201cFixing It\u201d Is Not Clean:"})," If you make the server update ",(0,i.jsx)(n.code,{children:"updated_at"}),' on write, it no longer represents "when the user made the change," breaking the meaning of the column. This is why we need a different column.']}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"2\ufe0f\u20e3-server-side-replication-recommended",children:"2\ufe0f\u20e3 Server-Side Replication (Recommended)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Uses:"})," ",(0,i.jsx)(n.code,{children:"arrived_at"})," as the sync cursor."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"How It Works"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Devices still send ",(0,i.jsx)(n.code,{children:"updated_at"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["But the server sets ",(0,i.jsx)(n.code,{children:"arrived_at = now()"})," when it receives the row."]}),"\n",(0,i.jsxs)(n.li,{children:["Sync uses ",(0,i.jsx)(n.code,{children:"arrived_at"}),", not ",(0,i.jsx)(n.code,{children:"updated_at"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Now the earlier problem disappears."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Same Scenario, Server-Side:"})}),"\n",(0,i.jsxs)(n.p,{children:["Now assume Supastash is using ",(0,i.jsx)(n.strong,{children:"server-side replication"})," with ",(0,i.jsx)(n.code,{children:"arrived_at"})," as the sync cursor."]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"10:00 AM"})," \u2014 Device A updates a row while offline.",(0,i.jsx)(n.br,{}),"\n","\u2192 ",(0,i.jsx)(n.code,{children:"updated_at = 10:00"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"10:05 AM"})," \u2014 Device B updates the same table while offline.",(0,i.jsx)(n.br,{}),"\n","\u2192 ",(0,i.jsx)(n.code,{children:"updated_at = 10:05"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"10:10 AM"})," \u2014 Device B reconnects and pushes its update.",(0,i.jsx)(n.br,{}),"\n","\u2192 The server stores the row and sets ",(0,i.jsx)(n.code,{children:"arrived_at = 10:10"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"10:20 AM"})," \u2014 Device C syncs.",(0,i.jsx)(n.br,{}),"\n","\u2192 It pulls Device B\u2019s update and stores:",(0,i.jsx)(n.br,{}),"\n","\u2192 ",(0,i.jsx)(n.code,{children:"last_synced_at = 10:10"})," (based on ",(0,i.jsx)(n.code,{children:"arrived_at"}),", not ",(0,i.jsx)(n.code,{children:"updated_at"}),")."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Later \u2014 Device A reconnects and pushes its update (",(0,i.jsx)(n.code,{children:"updated_at = 10:00"}),").",(0,i.jsx)(n.br,{}),"\n","\u2192 The server sets ",(0,i.jsx)(n.code,{children:"arrived_at = 11:00"})," (time of arrival)."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"what-happens-1",children:"What Happens?"}),"\n",(0,i.jsxs)(n.p,{children:["On the next sync, Device C ",(0,i.jsx)(n.strong,{children:"will pull Device A\u2019s update"}),", because:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"arrived_at (11:00) > last_synced_at (10:10)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Even though the change originally happened at 10:00 AM,",(0,i.jsx)(n.br,{}),"\n","it is synchronized based on ",(0,i.jsx)(n.strong,{children:"when it arrived at the server"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"That distinction prevents missed updates and guarantees correct ordering across devices."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-why-server-side-is-better",children:"\ud83d\udee1 Why Server-Side Is Better"}),"\n",(0,i.jsxs)(n.p,{children:["The example above says it all. Server-side replication orders sync by when data ",(0,i.jsx)(n.strong,{children:"arrives at the server"}),", not when a device originally set ",(0,i.jsx)(n.code,{children:"updated_at"}),".",(0,i.jsx)(n.br,{}),"\n","So even after long offline periods, updates are not skipped, ordering is based on arrival time, not device time."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-what-you-must-add-server-side-mode",children:"\ud83c\udfd7 What You Must Add (Server-Side Mode)"}),"\n",(0,i.jsxs)(n.p,{children:["Each synced table must include:\n",(0,i.jsx)(n.code,{children:"arrived_at timestamptz NOT NULL DEFAULT now()"})]}),"\n",(0,i.jsx)(n.p,{children:"And the server must control it with a trigger."}),"\n",(0,i.jsx)(n.h3,{id:"-trigger-function-server-controlled-arrival",children:"\ud83d\udd27 Trigger Function (Server-Controlled Arrival)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION enforce_server_arrival_timestamp()\nRETURNS trigger AS $$\nBEGIN\n  IF TG_OP = 'INSERT' THEN\n    NEW.arrived_at := now();\n    RETURN NEW;\n  END IF;\n\n  IF TG_OP = 'UPDATE' THEN\n    IF OLD.updated_at > NEW.updated_at THEN\n      RAISE EXCEPTION\n        'Stale update rejected. Existing updated_at (%) is newer than incoming (%)',\n        OLD.updated_at, NEW.updated_at;\n    END IF;\n\n    NEW.arrived_at := now();\n    RETURN NEW;\n  END IF;\n\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Attach to each table:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TRIGGER set_arrived_at\nBEFORE INSERT OR UPDATE ON public.orders\nFOR EACH ROW\nEXECUTE FUNCTION enforce_server_arrival_timestamp();\n\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-apply-to-multiple-tables",children:"\ud83d\udd01 Apply to Multiple Tables"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION apply_arrival_trigger_to_tables(table_names text[])\nRETURNS void AS $$\nDECLARE\n  t text;\nBEGIN\n  FOREACH t IN ARRAY table_names\n  LOOP\n    EXECUTE format(\n      'CREATE TRIGGER set_arrived_at\n       BEFORE INSERT OR UPDATE ON public.%I\n       FOR EACH ROW\n       EXECUTE FUNCTION enforce_server_arrival_timestamp();',\n      t\n    );\n  END LOOP;\nEND;\n$$ LANGUAGE plpgsql;\n\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Usage:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT apply_arrival_trigger_to_tables(\n  ARRAY['orders', 'order_items']\n);\n\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-final-comparison",children:"\ud83d\udccc Final Comparison"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Mode"}),(0,i.jsx)(n.th,{children:"Sync Cursor"}),(0,i.jsx)(n.th,{children:"Safe After Long Offline?"}),(0,i.jsx)(n.th,{children:"Clock Safe?"}),(0,i.jsx)(n.th,{children:"Recommended"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"client-side"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"updated_at"})}),(0,i.jsx)(n.td,{children:"\u274c No"}),(0,i.jsx)(n.td,{children:"\u274c No"}),(0,i.jsx)(n.td,{children:"Simple setups only"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"server-side"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"arrived_at"})}),(0,i.jsx)(n.td,{children:"\u2705 Yes"}),(0,i.jsx)(n.td,{children:"\u2705 Yes"}),(0,i.jsxs)(n.td,{children:["\u2705 ",(0,i.jsx)(n.strong,{children:"Production"})]})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-summary",children:"\ud83d\udd1a Summary"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Client-side"})," works for simple apps."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Server-side"})," works for real distributed offline systems."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["If you care about correctness across devices and long offline gaps, use ",(0,i.jsx)(n.strong,{children:"server-side replication"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>l});var r=s(6540);const i={},t=r.createContext(i);function d(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);